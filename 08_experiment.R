################################################################################
################################################################################
# EXPERIMENT
################################################################################
################################################################################

################################################################################
# FLAGS
################################################################################

FLAGS <- flags(flag_numeric("learning_rate", 1e-4),
               flag_numeric("l2_regularizer", 0.001),
               flag_integer("epochs", 200))

################################################################################
# MODEL
################################################################################

model <- get_lenet5(
  width_length = width_length,
  n_bands = n_bands,
  n_classes = n_classes,
  l2_regularizer = FLAGS$l2_regularizer)

################################################################################
# COMPILE
################################################################################

model %>% compile(
  optimizer = optimizer_rmsprop(lr = FLAGS$learning_rate,
                                decay = FLAGS$learning_rate / FLAGS$epochs),
  loss = "categorical_crossentropy",
  metrics = c("accuracy")
)

################################################################################
# TRAIN
################################################################################

# fit
history <- model %>% fit_generator(
  balanced$data_train,
  steps_per_epoch = balanced$steps_train,
  epochs = FLAGS$epochs,
  validation_data = balanced$data_vali,
  validation_steps = balanced$length_vali
)

################################################################################
# SAVE
################################################################################

# name <- paste0("lr_", FLAGS$learning_rate, "_ep_", FLAGS$epochs, "_l2_", FLAGS$l2_regularizer)
# model %>% save_model_hdf5(paste0(path_models, "/fold_", fold, "_", name, ".h5"))

################################################################################
# EVALUATE
################################################################################

results <- model %>% evaluate_generator(balanced$data_test, steps=balanced$length_test)

################################################################################